@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization
@model MusicShareWeb.Models.Lesson.TrainModel

@{
    Layout = "../Shared/Layout.cshtml";
}

@Html.Partial("Exercise")

<audio id="BitSound" preload="auto">
    <source src="/Content/bit.ogg" type='audio/ogg; codecs="vorbis"'>
    <source src="/Content/bit.mp3" type='audio/mpeg; codecs="mp3"'>
    <source src="/Content/bit.wav" type='audio/wav; codecs="1"'>
    <source src="/Content/bit.aac" type='audio/mp4; codecs="mp4a.40.5"'>
</audio>

<div id="Train">
    @if (Model.CurrentUser == null) {
        <span>Для загрузки данных плана занятий необходимо войти на сайт.</span>
    } else {
        <div class="plan-layout">
            <div class="plan">
                <div class="plan__all-exercises" data-bind="foreach: { data: $root.exercises, as: 'exercise' }">
                    <div data-bind="template: { name: 'ExerciseTemplate', data: {'exerciseId': exercise.id, 'exerciseName': $root.getExerciseTitle(exercise), 'audioUrl': exercise.audioUrl, 'imageUrl': exercise.imageUrl, 'min': false } }"></div>
                </div>
                <div class="plan__selected-exercises">
                    <div>
                        <input type="button" class="save-exercises-speed" value="Сохранить изменения" data-bind="click: $root.saveSpeeds" />
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script type="text/javascript">
    $(document).ready(function () {
        ko.applyBindings(getTrain(@Html.Raw(JsonConvert.SerializeObject(Model, Formatting.Indented, new JsonSerializerSettings { ContractResolver = new CamelCasePropertyNamesContractResolver() }))), document.getElementById("Train"));
    });

    getTrain = function (data) {
        var model = {};
        model.guitarTechniques = data.guitarTechniques;
        model.lessons = data.lessons;
        model.exercises = data.exercises;
        model.speeds = data.speeds;

        model.bitSound = document.getElementById('BitSound');
        //        if (!model.bitSound.src) {
        //            model.bitSound.src = model.bitSound.currentSrc;
        //            alert('Пытаемся сыграть ' + model.bitSound.src + '\nСыграем? -- '+ model.bitSound.canPlayType('video/ogg;codecs="theora, vorbis"'));
        //        }
        model.isRun = ko.observable(false);
        model.speeds = {};
        @Html.Raw(String.Join("\n", Model.Speeds.Select(s => "model.speeds['" + s.Key + "'] = ko.observable(" + s.Value + ");")))
        model.activeSpeedIndex = ko.observable(undefined);
        model.loop = undefined;
        model.exerciseHide = {};
        @Html.Raw(String.Join("\n", Model.Exercises.Select(s => "model.exerciseHide['" + s.Id + "'] = ko.observable(false);")))
        model.toggle = function(exerciseId) {
            if (model.exerciseHide[exerciseId]()) {
                model.exerciseHide[exerciseId](false);
                $('#Exercise' + exerciseId).css('display', 'block');
            } else {
                model.exerciseHide[exerciseId](true);
                $('#Exercise' + exerciseId).css('display', 'none');
            }
        }
        model.speedUp = function (index) {
            var wasRun = model.isRun();
            model.stop();
            model.speeds[index](model.speeds[index]() + 1.0);
            if (wasRun) {
                model.run(index);
            }
        }
        model.speedDown = function (index) {
            var wasRun = model.isRun();
            model.stop();
            model.speeds[index](model.speeds[index]() - 1.0);
            if (wasRun) {
                model.run(index);
            }
        }
        model.speedChange = function (index) {
            var wasRun = model.isRun();
            model.stop();
            model.speeds[index](parseInt(model.speeds[index](), 10));
            if (wasRun) {
                model.run(index);
            }
        }
        model.run = function (index) {
            model.activeSpeedIndex(index);
            model.isRun(true);
        }
        model.stop = function () {
            model.isRun(false);
        }
        var playSound = function () {
            model.bitSound.play();
        }
        model.isRun.subscribe(function() {
            if (model.isRun()) {
                var time = 60.0 / model.speeds[model.activeSpeedIndex()]() * 1000.0;
                playSound();
                model.loop = setInterval(playSound, time);
            } else {
                clearInterval(model.loop);
            }
        });
        model.saveSpeeds = function () {
            var speeds = {};
            var keys = Object.keys(model.speeds);
            for (var i = 0; i < keys.length; i++) {
                speeds[keys[i].toString()] = model.speeds[keys[i]]().toString();
            }
            $.ajax({
                url: '@Url.Action("SaveExercisesSpeed")',
                type: 'POST',
                traditional: true,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    speeds: speeds
                }),
                success: function (result) {
                    alert('Сохранено');
                },
                error: function (result) {
                    alert('Ошибка');
                }
            });
            return false;
        };

        model.getExerciseTitle = function (exercise) {
            var lesson = model.lessons.filter(function (lesson) {
                return exercise.lessonId === lesson.id;
            })[0];
            var guitarTechnique = model.guitarTechniques.filter(function (guitarTechnique) {
                return lesson.guitarTechniqueId === guitarTechnique.id;
            })[0];
            return guitarTechnique.shortName + ' ' + lesson.name + '. ' + exercise.name;
        };

        return model;
    };
</script>